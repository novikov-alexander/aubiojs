<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Guitar trainer</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/interactive-data-display/1.5.37/idd.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/3.1.2/rx.lite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.4.0/svg.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/interactive-data-display/1.5.37/idd.min.js"></script>  
  </head>
  <body>

    <div class="attacks">
      <div id="last-attack">0</div>
    </div>
    <audio
      src=".\sample.mp3"
      crossorigin="anonymous"
      controls
    ></audio>
    <script type='module'>
      import aubio  from './aubio.esm.js'; 
      const aubioRef = await aubio();

      const bufferSize = 4096;
      const hopSize = 1024;

      const volume = [];
      const pitch = [];
      const time = [];
      const volumeTime = [];
      const attackProb = [];
      const attackTime = [];
      let count = 0;
      let volumeCount = 0;
      $(document).ready(function () {
        InteractiveDataDisplay.asPlot('chart');
        InteractiveDataDisplay.asPlot('dynamics');
      });

      const audioContext = new (AudioContext || webkitAudioContext)();
      const scriptProcessor = audioContext.createScriptProcessor(hopSize, 1, 1);
      
      let audioSource;
      
      const colors = ['Green', 'Blue', 'Red'];
      const plot = InteractiveDataDisplay.asPlot('chart');
      const dynamics = InteractiveDataDisplay.asPlot('dynamics');
      

      const tolerance = 1;

      const dotsLimit = 100000;

      const onset = new aubioRef.Onset(
        "wphase",
        bufferSize,
        scriptProcessor.bufferSize,
        audioContext.sampleRate
      );

      onset.setThreshold(0.7);
      
      const pitchDetector = new aubioRef.Pitch(
        "default",
        bufferSize,
        scriptProcessor.bufferSize,
        audioContext.sampleRate
      ); 

      pitchDetector.setTolerance(tolerance);

      const audio = document.querySelector("audio");
      audio.addEventListener('play', () => {scriptProcessor.connect(audioContext.destination);});
      const audioProcess = function (event) {
        let data = event.inputBuffer.getChannelData(0);
        
        let frequency = pitchDetector.do(data);
        count++;
        time.push(volumeCount);
        if (frequency === 0){
          pitch.push(undefined);
        } else {
          while (frequency > 1000){
            frequency /= 2;
          }
          pitch.push(frequency);
        }

        for (let i = 0; i < hopSize; i++){
          volumeTime.push(volumeCount++);
          const volumeSmpl = data[i];
          if (volumeSmpl === 0){
            volume.push(undefined);
          } else {
            volume.push(volumeSmpl);
          }
        }

        if (onset.do(data)) {
          const t = onset.getLast();
          const f = pitch[Math.floor(t/hopSize)];
          attackTime.push(t);
          attackProb.push(pitch[Math.floor(t/hopSize)]);
          console.log("attack happened", 'attackTime:' + t + ' count:' + count + ' volumeCount:' + volumeCount + ' ' + f);
        }

        plot.navigation.setVisibleRect({ x: volumeCount - dotsLimit, y: 0, width: dotsLimit, height: 1000 });
        dynamics.navigation.setVisibleRect({ x: volumeCount - dotsLimit, y: -1, width: dotsLimit, height: 2 });
        plot.polyline("p", { x: time, y: pitch, stroke: colors[0], thickness: 3 });
        plot.markers("attack", { x: attackTime, y: attackProb, stroke: colors[0], thickness: 3 });
        dynamics.polyline("p", { x: volumeTime, y: volume, stroke: colors[0], thickness: 3 });
      }
      scriptProcessor.addEventListener("audioprocess", audioProcess);
      audio.addEventListener("pause", () => {
        scriptProcessor.removeEventListener("audioprocess", audioProcess);
      });

      audioSource =
        audioSource || audioContext.createMediaElementSource(audio);
      audioSource.connect(scriptProcessor);
      audioSource.connect(audioContext.destination);

      const $attack = document.querySelector("#last-attack");

      function attack(time) {
        $attack.innerHTML = parseFloat(time);
      }
    </script>
    <div id="chart" data-idd-plot="chart" style="width: 1680px; height: 525px;">
        <div data-idd-placement="bottom" class="idd-horizontalTitle">X</div>
        <div data-idd-placement="left" class="idd-verticalTitle" style="width: 20px">
            <div style="position: absolute; top: 50%; margin-top: -0.5em; height: 10em; width: 100px;">
                Y
            </div>
        </div>
    </div>
    <div id="dynamics" data-idd-plot="chart" style="width: 1680px; height: 525px;">
      <div data-idd-placement="bottom" class="idd-horizontalTitle">X</div>
      <div data-idd-placement="left" class="idd-verticalTitle" style="width: 20px">
          <div style="position: absolute; top: 50%; margin-top: -0.5em; height: 10em; width: 100px;">
              Y
          </div>
      </div>
  </div>
  </body>
</html>
